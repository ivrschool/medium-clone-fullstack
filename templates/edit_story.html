{% extends "base.html" %}

{% block content %}
<div class="editor-container">
    <div class="editor-header">
        <div class="container-fluid">
            <div class="row align-items-center py-3">
                <div class="col-6">
                    <a href="{{ url_for('dashboard') }}" class="text-decoration-none text-muted">
                        <i class="fas fa-arrow-left"></i> Back to Dashboard
                    </a>
                </div>
                <div class="col-6 text-end">
                    {% if story.published %}
                        <a href="{{ url_for('read_story', slug=story.slug) }}" class="btn btn-outline-primary btn-sm me-2">View Story</a>
                    {% endif %}
                    <button type="button" class="btn btn-outline-success btn-sm me-2" id="save-draft">Save Draft</button>
                    <button type="button" class="btn btn-success btn-sm" id="publish-story">{{ "Update" if story.published else "Publish" }}</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="editor-content">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <form method="POST" id="story-form">
                        {{ form.hidden_tag() }}
                        
                        <!-- Hidden fields for form submission -->
                        {{ form.title(style="display: none;", id="hidden-title") }}
                        {{ form.subtitle(style="display: none;", id="hidden-subtitle") }}
                        {{ form.content(style="display: none;", id="hidden-content") }}
                        {{ form.published(style="display: none;", id="hidden-published") }}
                        
                        <div class="editor-writing-area" style="position: relative;">
                            <div class="title-input" 
                                 contenteditable="true" 
                                 data-placeholder="Title" 
                                 id="editable-title">{{ story.title }}</div>
                            
                            <div class="subtitle-input" 
                                 contenteditable="true" 
                                 data-placeholder="Subtitle (optional)" 
                                 id="editable-subtitle">{{ story.subtitle or '' }}</div>
                            
                            <div class="story-input" 
                                 contenteditable="true" 
                                 data-placeholder="Tell your story..." 
                                 id="editable-content">{{ story.content|safe }}</div>
                            
                            <!-- Plus Button -->
                            <div class="plus-button" id="plus-button">
                                <i class="fas fa-plus"></i>
                            </div>
                            
                            <!-- Plus Menu -->
                            <div class="plus-menu" id="plus-menu">
                                <div class="plus-menu-item image" data-action="image">
                                    <div class="plus-menu-icon">
                                        <i class="fas fa-image"></i>
                                    </div>
                                    <div class="plus-menu-text">
                                        <div class="plus-menu-title">Image</div>
                                        <div class="plus-menu-desc">Upload an image from your device</div>
                                    </div>
                                </div>
                                <div class="plus-menu-item code" data-action="code">
                                    <div class="plus-menu-icon">
                                        <i class="fas fa-code"></i>
                                    </div>
                                    <div class="plus-menu-text">
                                        <div class="plus-menu-title">Code Block</div>
                                        <div class="plus-menu-desc">Insert a formatted code snippet</div>
                                    </div>
                                </div>
                                <div class="plus-menu-item divider" data-action="divider">
                                    <div class="plus-menu-icon">
                                        <i class="fas fa-minus"></i>
                                    </div>
                                    <div class="plus-menu-text">
                                        <div class="plus-menu-title">Divider</div>
                                        <div class="plus-menu-desc">Add a section break</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        {{ form.submit(style="display: none;", id="hidden-submit") }}
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Floating toolbar -->
    <div class="floating-toolbar" id="floating-toolbar" style="display: none;">
        <button type="button" class="toolbar-btn" data-command="bold" title="Bold">
            <i class="fas fa-bold"></i>
        </button>
        <button type="button" class="toolbar-btn" data-command="italic" title="Italic">
            <i class="fas fa-italic"></i>
        </button>
        <button type="button" class="toolbar-btn" data-command="underline" title="Underline">
            <i class="fas fa-underline"></i>
        </button>
        <div class="toolbar-separator"></div>
        <button type="button" class="toolbar-btn" data-heading="h1" title="Heading 1">H1</button>
        <button type="button" class="toolbar-btn" data-heading="h2" title="Heading 2">H2</button>
        <button type="button" class="toolbar-btn" data-heading="h3" title="Heading 3">H3</button>
        <div class="toolbar-separator"></div>
        <button type="button" class="toolbar-btn" data-command="insertUnorderedList" title="Bullet List">
            <i class="fas fa-list-ul"></i>
        </button>
        <button type="button" class="toolbar-btn" data-command="insertOrderedList" title="Numbered List">
            <i class="fas fa-list-ol"></i>
        </button>
        <button type="button" class="toolbar-btn" data-command="createLink" title="Link">
            <i class="fas fa-link"></i>
        </button>
    </div>
</div>

<!-- Status indicator -->
<div class="status-indicator" id="status-indicator">
    <span class="status-text">{{ "Published" if story.published else "Draft" }}</span>
    <span class="auto-save-status" id="auto-save-status"></span>
</div>

<!-- Image Upload Modal -->
<div class="image-upload-modal" id="image-upload-modal">
    <div class="image-upload-content">
        <div class="image-upload-header">
            <h3>Upload Image</h3>
        </div>
        
        <div class="image-upload-area" id="image-upload-area">
            <div class="image-upload-icon">
                <i class="fas fa-cloud-upload-alt"></i>
            </div>
            <p>Drag & drop an image here, or click to select</p>
            <input type="file" id="image-file-input" accept="image/*" style="display: none;">
        </div>
        
        <div id="image-preview-container" style="display: none;">
            <img id="image-preview" class="image-preview" alt="Preview">
        </div>
        
        <div class="image-upload-buttons">
            <button type="button" class="btn btn-outline-secondary" id="cancel-image-upload">Cancel</button>
            <button type="button" class="btn btn-primary" id="insert-image" disabled>Insert Image</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Set initial values for editing
    window.initialStoryData = {
        published: {{ story.published|tojson }}
    };
</script>
<script src="{{ url_for('static', filename='js/medium-editor.js') }}"></script>
{% endblock %}
